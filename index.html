<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Задания и призы</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .task, .prize { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .admin-panel { background: #f0f0f0; padding: 10px; }
        button { padding: 5px 10px; margin: 5px; cursor: pointer; }
        input, textarea { margin: 5px; padding: 5px; width: 100%; }
        img { max-width: 100px; max-height: 100px; }
    </style>
</head>
<body>
    <h1>Задания и призы</h1>
    <h3>Баллы: <span id="points">0</span></h3>

    <!-- Админ-логин -->
    <div id="admin-login" style="display: none;">
        <input type="password" id="admin-password" placeholder="Пароль админа">
        <button onclick="loginAsAdmin()">Войти</button>
    </div>

    <!-- Админ-панель -->
    <div id="admin-panel" class="admin-panel" style="display: none;">
        <h3>Админ-панель</h3>
        <input type="text" id="task-title" placeholder="Название задания">
        <input type="number" id="task-points" placeholder="Баллы">
        <button onclick="addTask()">Добавить задание</button>
        <br>
        <input type="text" id="prize-title" placeholder="Название приза">
        <input type="number" id="prize-cost" placeholder="Стоимость в баллах">
        <button onclick="addPrize()">Добавить приз</button>
    </div>

    <!-- Список заданий -->
    <h3>Задания</h3>
    <div id="task-list"></div>

    <!-- Магазин призов -->
    <h3>Магазин</h3>
    <div id="prize-list"></div>

    <script>
        const adminPassword = "admin123"; // Смените пароль
        let isAdmin = false;
        let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        let prizes = JSON.parse(localStorage.getItem('prizes') || '[]');
        let points = parseInt(localStorage.getItem('points') || '0');
        let pendingTasks = JSON.parse(localStorage.getItem('pendingTasks') || '[]');
        let lastReset = localStorage.getItem('lastReset') || new Date().toISOString().split('T')[0];

        // Начальные данные (можно редактировать)
        if (tasks.length === 0) {
            tasks = [
                { id: '1', title: 'Сделать фото с логотипом канала', points: 10, completed: false, pending: false },
                { id: '2', title: 'Написать пост о канале', points: 20, completed: false, pending: false }
            ];
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        if (prizes.length === 0) {
            prizes = [
                { id: '1', title: 'Стикеры канала', cost: 30 },
                { id: '2', title: 'Скидка 10% на мерч', cost: 50 }
            ];
            localStorage.setItem('prizes', JSON.stringify(prizes));
        }

        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Проверка сброса (раз в месяц)
        function checkReset() {
            const now = new Date();
            const resetDate = new Date(lastReset);
            const diffMonths = (now.getFullYear() - resetDate.getFullYear()) * 12 + now.getMonth() - resetDate.getMonth();
            if (diffMonths >= 1) {
                tasks = tasks.map(task => ({ ...task, completed: false, pending: false }));
                points = 0;
                pendingTasks = [];
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('points', points);
                localStorage.setItem('pendingTasks', JSON.stringify(pendingTasks));
                localStorage.setItem('lastReset', now.toISOString().split('T')[0]);
            }
        }

        // Вход админа
        function loginAsAdmin() {
            const password = document.getElementById('admin-password').value;
            if (password === adminPassword) {
                isAdmin = true;
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
            } else {
                alert('Неверный пароль');
            }
        }

        // Добавление задания
        function addTask() {
            const title = document.getElementById('task-title').value;
            const taskPoints = parseInt(document.getElementById('task-points').value);
            if (title && taskPoints > 0) {
                const id = Date.now().toString();
                tasks.push({ id, title, points: taskPoints, completed: false, pending: false });
                localStorage.setItem('tasks', JSON.stringify(tasks));
                renderTasks();
                document.getElementById('task-title').value = '';
                document.getElementById('task-points').value = '';
            }
        }

        // Добавление приза
        function addPrize() {
            const title = document.getElementById('prize-title').value;
            const cost = parseInt(document.getElementById('prize-cost').value);
            if (title && cost > 0) {
                const id = Date.now().toString();
                prizes.push({ id, title, cost });
                localStorage.setItem('prizes', JSON.stringify(prizes));
                renderPrizes();
                document.getElementById('prize-title').value = '';
                document.getElementById('prize-cost').value = '';
            }
        }

        // Отправка доказательства
        function submitTask(index) {
            const task = tasks[index];
            if (task.completed || task.pending) return;

            const proofDiv = document.createElement('div');
            proofDiv.innerHTML = `
                <textarea id="proof-text-${index}" placeholder="Опишите выполнение"></textarea>
                <input type="file" id="proof-file-${index}" accept="image/*">
                <button onclick="sendProof(${index})">Отправить</button>
            `;
            document.getElementById(`task-${index}`).appendChild(proofDiv);
        }

        // Отправка доказательства в Telegram
        function sendProof(index) {
            const task = tasks[index];
            const text = document.getElementById(`proof-text-${index}`).value;
            const fileInput = document.getElementById(`proof-file-${index}`);
            let proofData = { text };

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    proofData.image = e.target.result; // Data URL
                    tasks[index].pending = true;
                    pendingTasks.push({ taskId: task.id, userId: tg.initDataUnsafe.user?.id, proof: proofData });
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    localStorage.setItem('pendingTasks', JSON.stringify(pendingTasks));
                    tg.sendData(JSON.stringify({
                        action: 'task_proof',
                        taskId: task.id,
                        taskTitle: task.title,
                        userId: tg.initDataUnsafe.user?.id,
                        username: tg.initDataUnsafe.user?.username || 'unknown',
                        proof: proofData
                    }));
                    alert('Доказательство отправлено! Ожидайте подтверждения.');
                    renderTasks();
                };
                reader.readAsDataURL(file);
            } else {
                tasks[index].pending = true;
                pendingTasks.push({ taskId: task.id, userId: tg.initDataUnsafe.user?.id, proof: proofData });
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('pendingTasks', JSON.stringify(pendingTasks));
                tg.sendData(JSON.stringify({
                    action: 'task_proof',
                    taskId: task.id,
                    taskTitle: task.title,
                    userId: tg.initDataUnsafe.user?.id,
                    username: tg.initDataUnsafe.user?.username || 'unknown',
                    proof: proofData
                }));
                alert('Доказательство отправлено! Ожидайте подтверждения.');
                renderTasks();
            }
        }

        // Подтверждение задания (вызывается вручную через бота)
        window.approveTask = function(taskId, userId) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1 && !tasks[taskIndex].completed) {
                tasks[taskIndex].completed = true;
                tasks[taskIndex].pending = false;
                points += tasks[taskIndex].points;
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('points', points);
                const pendingIndex = pendingTasks.findIndex(p => p.taskId === taskId && p.userId === userId);
                if (pendingIndex !== -1) {
                    pendingTasks.splice(pendingIndex, 1);
                    localStorage.setItem('pendingTasks', JSON.stringify(pendingTasks));
                }
                renderTasks();
                document.getElementById('points').textContent = points;
            }
        };

        // Покупка приза
        function buyPrize(index) {
            if (points >= prizes[index].cost) {
                points -= prizes[index].cost;
                localStorage.setItem('points', points);
                document.getElementById('points').textContent = points;
                tg.sendData(JSON.stringify({
                    action: 'prize_bought',
                    prizeId: prizes[index].id,
                    prizeTitle: prizes[index].title,
                    userId: tg.initDataUnsafe.user?.id,
                    username: tg.initDataUnsafe.user?.username || 'unknown'
                }));
                alert(`Приз "${prizes[index].title}" куплен! Свяжитесь с админом.`);
            } else {
                alert('Недостаточно баллов');
            }
        }

        // Рендеринг заданий
        function renderTasks() {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            tasks.forEach((task, index) => {
                const div = document.createElement('div');
                div.className = 'task';
                div.id = `task-${index}`;
                div.innerHTML = `
                    ${task.title} (${task.points} баллов)
                    ${task.completed ? '<span>✓ Выполнено</span>' : task.pending ? '<span>Ожидает проверки</span>' : `<button onclick="submitTask(${index})">Выполнить</button>`}
                `;
                taskList.appendChild(div);
            });
        }

        // Рендеринг призов
        function renderPrizes() {
            const prizeList = document.getElementById('prize-list');
            prizeList.innerHTML = '';
            prizes.forEach((prize, index) => {
                const div = document.createElement('div');
                div.className = 'prize';
                div.innerHTML = `
                    ${prize.title} (${prize.cost} баллов)
                    <button onclick="buyPrize(${index})">Купить</button>
                `;
                prizeList.appendChild(div);
            });
        }

        // Инициализация
        checkReset();
        document.getElementById('points').textContent = points;
        if (tg.initDataUnsafe.user) {
            document.getElementById('admin-login').style.display = 'block';
        }
        renderTasks();
        renderPrizes();
    </script>
</body>
</html>